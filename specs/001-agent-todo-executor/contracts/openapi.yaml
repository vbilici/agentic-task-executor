openapi: 3.1.0
info:
  title: Agent-Driven TODO Executor API
  description: API for managing sessions, tasks, artifacts, and data items with AI agent execution
  version: 1.0.0
  contact:
    name: Libra Team

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.libra.app
    description: Production server

tags:
  - name: Sessions
    description: Session management endpoints
  - name: Tasks
    description: Task management endpoints
  - name: Messages
    description: Chat message endpoints
  - name: Artifacts
    description: Artifact management endpoints
  - name: DataItems
    description: Data item CRUD endpoints
  - name: Execution
    description: Agent execution endpoints (SSE)

paths:
  /sessions:
    get:
      tags: [Sessions]
      summary: List all sessions
      operationId: listSessions
      parameters:
        - name: status
          in: query
          schema:
            $ref: "#/components/schemas/SessionStatus"
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: List of sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: "#/components/schemas/Session"
                  total:
                    type: integer
                required:
                  - sessions
                  - total

    post:
      tags: [Sessions]
      summary: Create a new session
      operationId: createSession
      responses:
        "201":
          description: Session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"

  /sessions/{sessionId}:
    get:
      tags: [Sessions]
      summary: Get session details
      operationId: getSession
      parameters:
        - $ref: "#/components/parameters/sessionId"
      responses:
        "200":
          description: Session details with tasks, messages, artifacts, and data items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionDetail"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags: [Sessions]
      summary: Delete a session
      operationId: deleteSession
      parameters:
        - $ref: "#/components/parameters/sessionId"
      responses:
        "204":
          description: Session deleted
        "404":
          $ref: "#/components/responses/NotFound"

  /sessions/{sessionId}/chat:
    post:
      tags: [Messages]
      summary: Send a chat message and get streaming response
      description: Sends a user message to the agent and streams the response via SSE
      operationId: chat
      parameters:
        - $ref: "#/components/parameters/sessionId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: User's message content
                  minLength: 1
                  maxLength: 10000
              required:
                - message
      responses:
        "200":
          description: SSE stream of chat response
          content:
            text/event-stream:
              schema:
                $ref: "#/components/schemas/ChatStreamEvent"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/ValidationError"

  /sessions/{sessionId}/execute:
    post:
      tags: [Execution]
      summary: Execute tasks and stream progress
      description: Starts task execution and streams progress events via SSE
      operationId: executeTasks
      parameters:
        - $ref: "#/components/parameters/sessionId"
      responses:
        "200":
          description: SSE stream of execution events
          content:
            text/event-stream:
              schema:
                $ref: "#/components/schemas/ExecutionEvent"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Session not in planning status or no tasks to execute
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /sessions/{sessionId}/tasks:
    get:
      tags: [Tasks]
      summary: List tasks in a session
      operationId: listTasks
      parameters:
        - $ref: "#/components/parameters/sessionId"
      responses:
        "200":
          description: List of tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: "#/components/schemas/Task"
                required:
                  - tasks
        "404":
          $ref: "#/components/responses/NotFound"

  /sessions/{sessionId}/tasks/{taskId}:
    get:
      tags: [Tasks]
      summary: Get task details
      operationId: getTask
      parameters:
        - $ref: "#/components/parameters/sessionId"
        - $ref: "#/components/parameters/taskId"
      responses:
        "200":
          description: Task details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "404":
          $ref: "#/components/responses/NotFound"

  /sessions/{sessionId}/artifacts:
    get:
      tags: [Artifacts]
      summary: List artifacts in a session
      operationId: listArtifacts
      parameters:
        - $ref: "#/components/parameters/sessionId"
        - name: type
          in: query
          schema:
            $ref: "#/components/schemas/ArtifactType"
      responses:
        "200":
          description: List of artifacts
          content:
            application/json:
              schema:
                type: object
                properties:
                  artifacts:
                    type: array
                    items:
                      $ref: "#/components/schemas/Artifact"
                required:
                  - artifacts
        "404":
          $ref: "#/components/responses/NotFound"

  /sessions/{sessionId}/artifacts/{artifactId}:
    get:
      tags: [Artifacts]
      summary: Get artifact details
      operationId: getArtifact
      parameters:
        - $ref: "#/components/parameters/sessionId"
        - $ref: "#/components/parameters/artifactId"
      responses:
        "200":
          description: Artifact details with content
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Artifact"
        "404":
          $ref: "#/components/responses/NotFound"

  /sessions/{sessionId}/artifacts/{artifactId}/download:
    get:
      tags: [Artifacts]
      summary: Download artifact as file
      operationId: downloadArtifact
      parameters:
        - $ref: "#/components/parameters/sessionId"
        - $ref: "#/components/parameters/artifactId"
      responses:
        "200":
          description: Artifact file download
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: 'attachment; filename="artifact-name.txt"'
        "404":
          $ref: "#/components/responses/NotFound"

  /sessions/{sessionId}/data-items:
    get:
      tags: [DataItems]
      summary: List data items in a session
      operationId: listDataItems
      parameters:
        - $ref: "#/components/parameters/sessionId"
        - name: item_type
          in: query
          schema:
            type: string
          description: Filter by item type
      responses:
        "200":
          description: List of data items
          content:
            application/json:
              schema:
                type: object
                properties:
                  dataItems:
                    type: array
                    items:
                      $ref: "#/components/schemas/DataItem"
                required:
                  - dataItems
        "404":
          $ref: "#/components/responses/NotFound"

  /sessions/{sessionId}/data-items/{dataItemId}:
    get:
      tags: [DataItems]
      summary: Get data item details
      operationId: getDataItem
      parameters:
        - $ref: "#/components/parameters/sessionId"
        - $ref: "#/components/parameters/dataItemId"
      responses:
        "200":
          description: Data item details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DataItem"
        "404":
          $ref: "#/components/responses/NotFound"

  /health:
    get:
      summary: Health check
      operationId: healthCheck
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time

components:
  parameters:
    sessionId:
      name: sessionId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Session unique identifier

    taskId:
      name: taskId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Task unique identifier

    artifactId:
      name: artifactId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Artifact unique identifier

    dataItemId:
      name: dataItemId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Data item unique identifier

  schemas:
    SessionStatus:
      type: string
      enum: [planning, executing, completed]

    TaskStatus:
      type: string
      enum: [pending, in_progress, done, failed]

    MessageRole:
      type: string
      enum: [user, assistant, system]

    ArtifactType:
      type: string
      enum: [document, note, summary, plan, other]

    Session:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 200
        status:
          $ref: "#/components/schemas/SessionStatus"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - title
        - status
        - createdAt
        - updatedAt

    SessionDetail:
      allOf:
        - $ref: "#/components/schemas/Session"
        - type: object
          properties:
            tasks:
              type: array
              items:
                $ref: "#/components/schemas/Task"
            messages:
              type: array
              items:
                $ref: "#/components/schemas/Message"
            artifacts:
              type: array
              items:
                $ref: "#/components/schemas/ArtifactSummary"
            dataItems:
              type: array
              items:
                $ref: "#/components/schemas/DataItem"
          required:
            - tasks
            - messages
            - artifacts
            - dataItems

    Task:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sessionId:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 500
        description:
          type: string
          maxLength: 2000
          nullable: true
        status:
          $ref: "#/components/schemas/TaskStatus"
        result:
          type: string
          nullable: true
        reflection:
          type: string
          nullable: true
        order:
          type: integer
          minimum: 0
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - sessionId
        - title
        - status
        - order
        - createdAt
        - updatedAt

    Message:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sessionId:
          type: string
          format: uuid
        role:
          $ref: "#/components/schemas/MessageRole"
        content:
          type: string
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - sessionId
        - role
        - content
        - createdAt

    Artifact:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sessionId:
          type: string
          format: uuid
        taskId:
          type: string
          format: uuid
          nullable: true
        name:
          type: string
          maxLength: 200
        type:
          $ref: "#/components/schemas/ArtifactType"
        content:
          type: string
          maxLength: 102400
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - sessionId
        - name
        - type
        - content
        - createdAt

    ArtifactSummary:
      type: object
      description: Artifact without content for listing
      properties:
        id:
          type: string
          format: uuid
        sessionId:
          type: string
          format: uuid
        taskId:
          type: string
          format: uuid
          nullable: true
        name:
          type: string
          maxLength: 200
        type:
          $ref: "#/components/schemas/ArtifactType"
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - sessionId
        - name
        - type
        - createdAt

    DataItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sessionId:
          type: string
          format: uuid
        itemType:
          type: string
          maxLength: 100
        data:
          type: object
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - sessionId
        - itemType
        - data
        - createdAt
        - updatedAt

    ChatStreamEvent:
      type: object
      description: SSE event during chat streaming
      properties:
        type:
          type: string
          enum: [content, tasks_updated, error, done]
        content:
          type: string
          description: Streamed text content (for type=content)
        tasks:
          type: array
          items:
            $ref: "#/components/schemas/Task"
          description: Updated task list (for type=tasks_updated)
        error:
          type: string
          description: Error message (for type=error)
      required:
        - type

    ExecutionEvent:
      type: object
      description: SSE event during task execution
      properties:
        type:
          type: string
          enum:
            - task_selected
            - tool_call
            - tool_result
            - artifact_created
            - data_modified
            - task_completed
            - reflection
            - error
            - done
        taskId:
          type: string
          format: uuid
        tool:
          type: string
          description: Tool name (for type=tool_call)
        input:
          type: object
          description: Tool input (for type=tool_call)
        output:
          type: string
          description: Tool output or result
        artifactId:
          type: string
          format: uuid
          description: Created artifact ID (for type=artifact_created)
        dataItemId:
          type: string
          format: uuid
          description: Modified data item ID (for type=data_modified)
        status:
          $ref: "#/components/schemas/TaskStatus"
          description: Task status (for type=task_completed)
        text:
          type: string
          description: Reflection text (for type=reflection)
        error:
          type: string
          description: Error message (for type=error)
      required:
        - type

    Error:
      type: object
      properties:
        code:
          type: string
          description: Machine-readable error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Additional error details
      required:
        - code
        - message

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: NOT_FOUND
            message: Session not found

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            code: VALIDATION_ERROR
            message: Invalid request body
            details:
              field: message
              error: Field is required
